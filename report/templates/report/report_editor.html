{% extends 'event/base.html' %}

{% block title %}Report Gen{% endblock %}

{% load static %}


{% block content %}

  <!-- CKEditor 5 CDN -->
  <script src="https://cdn.ckeditor.com/ckeditor5/39.0.1/classic/ckeditor.js"></script>

  <style>
    /* Hidden iframe for PDF print */
    #pdf-frame {
      display: none;
    }
  </style>

  <div class="flex flex-col items-center max-w-xl mx-auto p-4">
  <!-- Prompt + Actions -->
  
  <!-- CKEditor Instance -->
  <div class="bg-gray-200 p-4 rounded-lg shadow-md m-5">
    <div id="editor-container">
      <div id="editor">Generate your report...</div>
    </div>
  </div>

  <div id="prompt-bar" class=" p-4 ">
    <input type="text" id="prompt-input" class="w-full p-2 border border-gray-300 rounded mb-2" placeholder="Enter a prompt...">
    <button onclick="generateText()" class="bg-gradient-to-r from-purple-500 via-pink-500 to-red-500 text-white p-4 rounded-lg text-white px-4 py-2 rounded">Generate âœ¨</button>
    <button onclick="downloadPDF()" class="bg-blue-500 hover:bg-blue-700 text-white px-4 py-2 rounded">Download PDF</button>
  </div>

  </div>
  
  <!-- Hidden iframe for print-to-PDF -->
  <iframe id="pdf-frame"></iframe>

  <script>
    let editorInstance;

    // Initialize CKEditor
    ClassicEditor
      .create(document.querySelector('#editor'))
      .then(editor => {
        editorInstance = editor;
      })
      .catch(error => {
        console.error(error);
      });

    // CSRF helper for Django
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
          cookie = cookie.trim();
          if (cookie.startsWith(name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    const csrftoken = getCookie('csrftoken');

    // Generate text from prompt
    function generateText() {
      const prompt = document.getElementById('prompt-input').value;
      if (!prompt) return alert("Please enter a prompt.");

      fetch('/report/chat/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({ prompt: prompt })
      })
      .then(res => res.json())
      .then(data => {
        const text = data.reply || 'No text generated.';
        editorInstance.setData('');
        editorInstance.setData(text);
      })
      .catch(err => {
        console.error('Generation error:', err);
        alert('Failed to generate text. Check console.');
      });
    }

    // Download editor content as PDF using print() method
    function downloadPDF() {
        const content = editorInstance.getData();
        const iframe = document.getElementById('pdf-frame');
        const doc = iframe.contentWindow.document;
      
        const header = `
          <div id="pdf-header">
            <img src="${window.location.origin}/static/report/logo.png" alt="Logo" style="height: 30px; vertical-align: middle; margin-right: 10px;">
            <span style="font-size: 14px; font-weight: bold;">| Event Report</span>
          </div>
        `;
      
        const footer = `
          <div id="pdf-footer">
            <p> Generated by RSET Descripto</p>
          </div>
        `;
      
        doc.open();
        doc.write(`
          <html>
            <head>
              <title>Generated Document</title>
              <style>
                body {
                  font-family: Arial, sans-serif;
                  margin: 80px 40px 70px 40px; /* smaller space for header/footer */
                  line-height: 1.6;
                }
      
                #pdf-header {
                  position: fixed;
                  top: 0;
                  left: 0;
                  right: 0;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  padding: 10px 0;
                  border-bottom: 1px solid #ccc;
                  background: white;
                }
      
                #pdf-footer {
                  position: fixed;
                  bottom: 0;
                  left: 0;
                  right: 0;
                  text-align: center;
                  padding: 8px 0;
                  font-size: 11px;
                  color: gray;
                  border-top: 1px solid #ccc;
                  background: white;
                }
      
                .content-wrapper {
                  width: 100%;
                }
              </style>
            </head>
            <body>
              ${header}
              <div class="content-wrapper">
                ${content}
              </div>
              ${footer}
            </body>
          </html>
        `);
        doc.close();
      
        iframe.onload = () => {
          iframe.contentWindow.focus();
          iframe.contentWindow.print();
        };
      }
  </script>

{% endblock %}
